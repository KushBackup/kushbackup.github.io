import React, { useState, useEffect, useMemo } from 'react';
import { 
  Search, 
  Lock, 
  Unlock, 
  User, 
  Users, 
  Fingerprint, 
  ShieldCheck, 
  Calculator, 
  ChevronRight,
  AlertTriangle,
  Ghost,
  X,
  FileText,
  Paperclip
} from 'lucide-react';

// --- MOCK DATA GENERATION ---

const PROFESSIONS = [
  "UX Designer", "Software Engineer", "Marketing Guru", "Accountant", "Yoga Instructor",
  "Professional Gamer", "Barista", "Cat Psychologist", "Crypto Bro", "Novel Writer"
];

const QUIRKS = [
  "Always speaks in riddles.", "Can't whisper.", "Hates the color blue.", 
  "Claims to be a time traveler.", "Allergic to silence.", "Collects weird spoons.",
  "Laughs at inappropriate times.", "Suspects everyone.", "Is secretly a mime.", "Only drinks water."
];

const SECRETS = [
  "I owe the victim $500.",
  "I was seen arguing with the victim about pineapple on pizza.",
  "I am actually the victim's long-lost half-sibling.",
  "I stole the victim's lucky stapler.",
  "I tried to get the victim fired last year.",
  "I have a crush on the victim's partner.",
  "I accidentally deleted the victim's Netflix profile."
];

// Generate 30 Characters
const generateCharacters = () => {
  const chars = [];
  
  // 1 Victim
  chars.push({
    id: 'char_0',
    name: "Baron Von Snooty",
    role: "VICTIM",
    profession: "Tech Mogul",
    bio: "The man of the hour. Currently recovering in the VIP lounge with a headache. He insists the music is too loud.",
    quirk: "Rich but stingy.",
    secret: "I staged this whole thing... wait, did I?",
    code: "VICTIM_ZERO"
  });

  // 1 Murderer
  chars.push({
    id: 'char_1',
    name: "Alex 'The Shadow'",
    role: "MURDERER",
    profession: "Head Chef",
    bio: "A culinary genius with a history of kitchen nightmares. Known for sharp knives and short tempers.",
    quirk: "Twitches when people order well-done steak.",
    secret: "I put the 'special' ingredient in the martini. But it was just supposed to be a laxative!",
    code: "KNIFE_SKILLS"
  });

  // 28 Innocents
  for (let i = 2; i < 30; i++) {
    chars.push({
      id: `char_${i}`,
      name: `Guest ${i + 1}`, // Placeholder names
      role: "INNOCENT",
      profession: PROFESSIONS[i % PROFESSIONS.length],
      bio: `A guest at the party. Just here for the free drinks, networking, and the potential drama.`,
      quirk: QUIRKS[i % QUIRKS.length],
      secret: SECRETS[i % SECRETS.length],
      code: `GUEST_${i}_CODE`
    });
  }
  return chars;
};

const CHARACTERS = generateCharacters();

// Game Logic / Clue Database
const CLUE_DB = [
  {
    id: 1,
    code: "START",
    title: "Case Opened",
    content: "The Victim, Baron Von Snooty, collapsed at 8:15 PM. He is alive but claims his Espresso Martini tasted like 'Betrayal and Almonds'.",
    type: "STORY",
    locked: false 
  },
  {
    id: 2,
    code: "BAR",
    title: "The Bar Tab",
    content: "You found the receipt! The Baron bought 4 drinks. One for himself, one for the Accountant, one for the UX Designer, and one for the Cat Psychologist.",
    type: "CLUE",
    locked: true
  },
  {
    id: 3,
    code: "NAPKIN",
    title: "Scribbled Note",
    content: "Found under a coaster: 'Meet me by the DJ booth at 8:00 PM. Bring the cash.' Handwriting looks jagged.",
    type: "CLUE",
    locked: true
  },
  {
    id: 4,
    code: "POISON",
    title: "Tox Report",
    content: "It wasn't cyanide... it was expired almond milk! The Baron has a severe nut allergy. Who ordered the milk?",
    type: "REVELATION",
    locked: true
  },
  {
    id: 5,
    code: "KNIFE_SKILLS",
    title: "Chef's Confession",
    content: "Wait, the Chef has this code? UNLOCKED INTEL: The Chef was seen carrying a carton of Almond Milk earlier.",
    type: "SUSPECT_INTEL",
    locked: true
  },
  {
    id: 6,
    code: "FELINE",
    title: "The Cat's Meow",
    content: "The Cat Psychologist confirms the Baron hates cats. This is a motive!",
    type: "MOTIVE",
    locked: true
  }
];

// Static Case Files Data
const CASE_FILES = [
  {
    id: 'f1',
    type: 'REPORT',
    title: 'INCIDENT REPORT #992',
    date: 'Oct 31, 8:30 PM',
    content: "At approx 20:15 hours, Baron Von Snooty (Male, 45) was observed collapsing near the chocolate fountain. Subject was clutching a martini glass. Initial assessment suggests foul play involving a tainted beverage. All exits have been secured. No one leaves until the truth is found.",
    stamped: true
  },
  {
    id: 'f2',
    type: 'FIR',
    title: 'OFFICIAL POLICE FIR',
    content: {
      location: "The Rusty Cauldron Bar",
      complainant: "Anonymous Tipster",
      details: "Attempted poisoning via beverage. Substance unknown. Suspect is believed to be within the premises.",
      notes: "Officers delayed by zombie parade traffic."
    }
  },
  {
    id: 'f3',
    type: 'IMAGE',
    title: 'CCTV FEED: CAM 04',
    caption: "Subject seen arguing with a figure in a chef's hat.",
    sketchType: 'CCTV_CHEF'
  },
  {
    id: 'f4',
    type: 'IMAGE',
    title: 'EVIDENCE PHOTO #1',
    caption: "The tainted glass found at the scene.",
    sketchType: 'MARTINI'
  }
];

// --- SVGs as Components for Doodles ---

const DoodleCoffeeStain = () => (
  <svg viewBox="0 0 100 100" className="absolute top-0 right-0 w-24 h-24 opacity-20 pointer-events-none mix-blend-multiply text-amber-800" fill="currentColor">
    <path d="M50 10 C 70 10 90 30 90 50 C 90 70 70 90 50 90 C 30 90 10 70 10 50 C 10 30 30 10 50 10 M 50 15 C 35 15 20 30 18 50 C 16 70 35 85 50 85 C 70 85 85 70 85 50 C 85 30 70 15 50 15" />
  </svg>
);

const DoodleStickFigure = () => (
  <svg viewBox="0 0 100 100" className="w-full h-full stroke-stone-800 stroke-2 fill-none" strokeLinecap="round">
    {/* Box frame */}
    <rect x="5" y="5" width="90" height="90" strokeDasharray="5,5" />
    <text x="10" y="20" className="text-[8px] fill-red-600 font-mono font-bold">REC ‚óè</text>
    {/* Stick figure 1 */}
    <circle cx="30" cy="40" r="5" />
    <line x1="30" y1="45" x2="30" y2="70" />
    <line x1="30" y1="50" x2="15" y2="60" />
    <line x1="30" y1="50" x2="45" y2="60" />
    <line x1="30" y1="70" x2="20" y2="90" />
    <line x1="30" y1="70" x2="40" y2="90" />
    {/* Stick figure 2 (Chef) */}
    <path d="M60 35 Q 70 20 80 35 L 80 40 L 60 40 Z" /> {/* Hat */}
    <circle cx="70" cy="45" r="5" />
    <line x1="70" y1="50" x2="70" y2="75" />
    <line x1="70" y1="55" x2="55" y2="50" /> {/* Pointing arm */}
    <line x1="70" y1="55" x2="85" y2="65" />
    <line x1="70" y1="75" x2="60" y2="90" />
    <line x1="70" y1="75" x2="80" y2="90" />
  </svg>
);

const DoodleMartini = () => (
  <svg viewBox="0 0 100 100" className="w-full h-full stroke-stone-800 stroke-2 fill-none" strokeLinecap="round">
    <rect x="5" y="5" width="90" height="90" className="fill-white" stroke="none" />
    <rect x="5" y="5" width="90" height="90" className="stroke-stone-300" strokeWidth="1" />
    <path d="M30 30 L 50 60 L 70 30 Z" /> {/* Glass bowl */}
    <line x1="50" y1="60" x2="50" y2="80" /> {/* Stem */}
    <line x1="40" y1="80" x2="60" y2="80" /> {/* Base */}
    <circle cx="45" cy="40" r="3" className="fill-green-900 stroke-none" /> {/* Olive */}
    <path d="M55 25 L 65 20" strokeDasharray="2,2"/> {/* Fumes */}
    <path d="M60 25 L 70 20" strokeDasharray="2,2"/>
    <text x="10" y="90" className="text-[8px] fill-stone-500 font-mono">EXHIBIT A</text>
  </svg>
);

export default function App() {
  const [currentUser, setCurrentUser] = useState(null);
  const [activeTab, setActiveTab] = useState('DASHBOARD');
  const [unlockedClues, setUnlockedClues] = useState([1]);
  const [inputCode, setInputCode] = useState("");
  const [feedback, setFeedback] = useState(null);
  const [modalOpen, setModalOpen] = useState(false);
  const [selectedGuest, setSelectedGuest] = useState(null);

  const myCharacter = useMemo(() => 
    CHARACTERS.find(c => c.id === currentUser), 
  [currentUser]);

  const handleLogin = (id) => {
    setCurrentUser(id);
    setActiveTab('DASHBOARD');
  };

  const handleCodeSubmit = (e) => {
    e.preventDefault();
    const normalizedCode = inputCode.trim().toUpperCase();
    
    const foundClue = CLUE_DB.find(c => c.code === normalizedCode);
    const foundChar = CHARACTERS.find(c => c.code === normalizedCode);

    if (foundClue) {
      if (unlockedClues.includes(foundClue.id)) {
        setFeedback({ type: 'info', msg: "You already know this!" });
      } else {
        setUnlockedClues([...unlockedClues, foundClue.id]);
        setFeedback({ type: 'success', msg: `FOUND: ${foundClue.title}` });
        setModalOpen(false);
        setActiveTab('INTEL');
      }
    } else if (foundChar) {
       setFeedback({ type: 'success', msg: `MET: ${foundChar.name}. Ask for their alibi!` });
    } else {
      setFeedback({ type: 'error', msg: "WRONG CODE!" });
    }
    
    setInputCode("");
    setTimeout(() => setFeedback(null), 3000);
  };

  // --- LOGIN SCREEN ---
  if (!currentUser) {
    return (
      <div className="min-h-screen bg-[#f4f1ea] text-stone-900 font-handwritten relative overflow-hidden flex flex-col items-center justify-center p-4 bg-texture">
        {/* Safe Font Loading */}
        <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet" />
        
        {/* Blood Splatters */}
        <div className="absolute top-0 left-0 w-48 h-48 sm:w-64 sm:h-64 bg-red-700/20 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2 pointer-events-none mix-blend-multiply"></div>
        <div className="absolute bottom-0 right-0 w-64 h-64 sm:w-80 sm:h-80 bg-orange-600/20 rounded-full blur-3xl translate-x-1/3 translate-y-1/3 pointer-events-none mix-blend-multiply"></div>

        <div className="max-w-md w-full relative z-10">
          <div className="text-center mb-6 sm:mb-8">
            <div className="mx-auto h-20 w-20 sm:h-24 sm:w-24 bg-white border-4 border-stone-900 rounded-full flex items-center justify-center shadow-sketch-lg rotate-3 mb-4">
              <Ghost size={40} className="text-orange-600 sm:w-12 sm:h-12" />
            </div>
            <h1 className="text-4xl sm:text-5xl font-black text-stone-900 tracking-tighter drop-shadow-sm rotate-[-2deg]">
              MURDER <span className="text-red-700">MYSTERY</span>
            </h1>
            <p className="mt-2 text-stone-600 text-base sm:text-lg font-bold">The Digital Almanac</p>
          </div>

          <div className="bg-white p-2 border-2 border-stone-900 shadow-sketch rounded-sm rotate-1">
            <div className="border border-stone-300 p-3 sm:p-4 border-dashed rounded-sm bg-[#fafafa]">
              <h3 className="text-xl sm:text-2xl font-bold mb-4 text-orange-600 text-center uppercase tracking-widest decoration-wavy underline decoration-stone-400">Who Are You?</h3>
              
              <div className="space-y-3 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
                {CHARACTERS.map(char => (
                  <button
                    key={char.id}
                    onClick={() => handleLogin(char.id)}
                    className="w-full text-left p-3 border-b-2 border-stone-200 hover:bg-orange-50 active:bg-orange-100 hover:border-orange-300 transition-all flex justify-between items-center group font-bold text-stone-700 active:scale-[0.98]"
                  >
                    <span className="truncate mr-2">{char.name}</span>
                    <span className="text-xs bg-stone-200 px-2 py-1 rounded-sm text-stone-500 whitespace-nowrap group-hover:bg-orange-200 group-hover:text-orange-800">
                      {char.profession}
                    </span>
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>
        <style>{`
        body { font-family: 'Gloria Hallelujah', 'Comic Sans MS', 'Chalkboard SE', 'Comic Neue', sans-serif; }
        .font-handwritten { font-family: 'Gloria Hallelujah', 'Comic Sans MS', 'Chalkboard SE', 'Comic Neue', sans-serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e7e5e4; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ea580c; border: 2px solid #e7e5e4; border-radius: 0; }
        
        .shadow-sketch { box-shadow: 2px 2px 0px 0px #1c1917; }
      `}</style>
      </div>
    );
  }

  // --- MAIN APP ---
  return (
    <div className="min-h-screen bg-[#f4f1ea] text-stone-900 font-handwritten pb-20 sm:pb-24 relative overflow-hidden bg-texture">
      {/* Safe Font Loading */}
      <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet" />
      
      {/* Background Decor */}
      <div className="fixed top-0 left-0 w-full h-2 bg-red-700 z-50"></div>
      <div className="fixed top-20 right-[-20px] w-20 h-20 bg-red-600 rounded-full blur-xl opacity-20 pointer-events-none"></div>

      {/* Header */}
      <header className="sticky top-0 z-30 bg-[#f4f1ea]/95 border-b-4 border-stone-900 p-3 sm:p-4 shadow-sm">
        <div className="flex justify-between items-center max-w-2xl mx-auto">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 sm:w-10 sm:h-10 bg-orange-500 border-2 border-stone-900 rounded-lg flex items-center justify-center rotate-3 shadow-[2px_2px_0px_rgba(0,0,0,1)]">
              <Ghost size={20} className="text-white sm:w-6 sm:h-6" />
            </div>
            <div>
              <h2 className="text-xl sm:text-2xl font-black leading-none text-stone-900 uppercase">The Case</h2>
              <span className="text-[10px] sm:text-xs text-red-600 font-bold tracking-widest bg-red-100 px-1">UNSOLVED</span>
            </div>
          </div>
          <button 
            onClick={() => setCurrentUser(null)}
            className="text-xs sm:text-sm font-bold text-stone-500 hover:text-red-600 underline decoration-2 decoration-wavy p-2"
          >
            Leave
          </button>
        </div>
      </header>

      {/* Main Content */}
      <main className="p-3 sm:p-4 max-w-2xl mx-auto space-y-6 sm:space-y-8">

        {/* FEEDBACK TOAST */}
        {feedback && (
          <div className={`fixed top-20 left-4 right-4 z-50 p-4 border-4 shadow-sketch-lg flex items-center gap-3 animate-bounce-short rotate-1 ${
            feedback.type === 'error' ? 'bg-red-100 border-red-700 text-red-900' : 
            feedback.type === 'success' ? 'bg-green-100 border-green-700 text-green-900' :
            'bg-blue-100 border-blue-700 text-blue-900'
          }`}>
            {feedback.type === 'error' ? <AlertTriangle size={24} /> : <ShieldCheck size={24} />}
            <span className="font-black text-sm sm:text-lg">{feedback.msg}</span>
          </div>
        )}

        {/* --- DASHBOARD --- */}
        {activeTab === 'DASHBOARD' && (
          <div className="space-y-6 animate-fade-in">
            {/* ID Card */}
            <div className="bg-white p-1 border-2 border-stone-900 shadow-sketch-lg rotate-[-1deg]">
              <div className="border border-stone-300 p-4 sm:p-6 relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')]">
                <DoodleCoffeeStain />
                
                <div className="relative z-10">
                  <div className="flex flex-col items-center mb-6">
                     <div className="w-20 h-20 sm:w-24 sm:h-24 bg-stone-100 border-2 border-dashed border-stone-400 rounded-full flex items-center justify-center mb-2">
                        <Fingerprint size={40} className="text-stone-300 sm:w-12 sm:h-12" />
                     </div>
                    <h1 className="text-2xl sm:text-3xl font-black text-stone-900 text-center uppercase">{myCharacter.name}</h1>
                    <span className="bg-stone-900 text-white px-3 py-1 text-xs sm:text-sm font-bold rotate-1 shadow-sm mt-1 transform">
                      {myCharacter.profession}
                    </span>
                  </div>

                  {myCharacter.role === 'MURDERER' ? (
                     <div className="bg-red-100 border-l-4 border-red-600 p-3 mb-4 rotate-1">
                        <p className="text-red-800 font-bold uppercase text-center text-lg sm:text-xl">‚ö†Ô∏è You are the Murderer</p>
                     </div>
                  ) : myCharacter.role === 'VICTIM' ? (
                    <div className="bg-purple-100 border-l-4 border-purple-600 p-3 mb-4 rotate-1">
                        <p className="text-purple-800 font-bold uppercase text-center text-lg sm:text-xl">ü§ï You are the Victim</p>
                    </div>
                  ) : (
                    <div className="bg-green-100 border-l-4 border-green-600 p-3 mb-4 rotate-1">
                        <p className="text-green-800 font-bold uppercase text-center text-lg sm:text-xl">‚úÖ Innocent Bystander</p>
                    </div>
                  )}

                  <div className="space-y-4 font-bold text-stone-700 text-sm sm:text-base">
                    <div className="bg-orange-50 p-4 border-2 border-orange-200 rounded-sm relative">
                        <div className="absolute -top-3 -left-2 bg-orange-500 text-white px-2 py-0.5 text-[10px] sm:text-xs rotate-[-3deg] border border-stone-900 shadow-sm">SECRET</div>
                        <p className="italic">"{myCharacter.secret}"</p>
                    </div>

                    <div className="bg-white p-4 border-2 border-stone-200 rounded-sm relative">
                        <div className="absolute -top-3 -left-2 bg-stone-800 text-white px-2 py-0.5 text-[10px] sm:text-xs rotate-[2deg] border border-stone-900 shadow-sm">MISSION</div>
                        <p>
                        {myCharacter.role === 'MURDERER' 
                            ? "Deflect suspicion. Find out who has the 'TOX_REPORT' code and convince them it's fake." 
                            : "Find the person who is a 'Cat Psychologist' and ask for their clearance code."}
                        </p>
                    </div>
                    
                    <div className="mt-6 border-t-2 border-dashed border-stone-300 pt-4 text-center">
                        <p className="text-xs text-stone-400 uppercase tracking-widest mb-1">Your Access Code</p>
                        <span className="text-2xl sm:text-3xl font-black text-red-700 tracking-widest font-mono bg-red-50 px-4 py-2 border border-red-200 rotate-1 inline-block select-all">
                            {myCharacter.code}
                        </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* --- INTEL --- */}
        {activeTab === 'INTEL' && (
          <div className="space-y-6 animate-fade-in">
            <h2 className="text-2xl sm:text-3xl font-black text-stone-900 text-center uppercase decoration-wavy underline decoration-orange-500">Evidence Board</h2>
            
            <div className="grid gap-4 sm:gap-6">
              {CLUE_DB.map((clue, idx) => {
                const isUnlocked = unlockedClues.includes(clue.id);
                // Random rotation for sticky note effect
                const rotation = idx % 2 === 0 ? 'rotate-1' : 'rotate-[-1deg]';
                
                return (
                  <div 
                    key={clue.id} 
                    className={`relative p-4 border-2 shadow-sketch transition-all ${rotation} ${
                      isUnlocked 
                        ? 'bg-white border-stone-900' 
                        : 'bg-stone-200 border-stone-400 border-dashed opacity-80'
                    }`}
                  >
                    {/* Tape Effect */}
                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-16 sm:w-24 h-6 bg-yellow-200/50 rotate-1 border-l border-r border-white/50 backdrop-blur-sm shadow-sm"></div>

                    <div className="flex justify-between items-start mb-3 pt-2">
                      <h3 className={`text-lg sm:text-xl font-black uppercase ${isUnlocked ? 'text-red-700' : 'text-stone-500'}`}>
                        {isUnlocked ? clue.title : 'LOCKED FILE'}
                      </h3>
                      {isUnlocked ? <Unlock size={18} className="text-green-600"/> : <Lock size={18} className="text-stone-400"/>}
                    </div>
                    
                    {isUnlocked ? (
                      <div>
                          <p className="text-base sm:text-lg font-bold text-stone-800 leading-snug font-serif italic mb-2">"{clue.content}"</p>
                          {clue.type === 'REVELATION' && (
                              <div className="inline-block bg-red-600 text-white px-2 py-1 text-[10px] sm:text-xs font-black rotate-[-2deg] border border-stone-900">
                                  KEY EVIDENCE
                              </div>
                          )}
                      </div>
                    ) : (
                      <div className="flex flex-col items-center justify-center py-4 gap-2 text-stone-400">
                          <p className="text-xs sm:text-sm font-bold bg-stone-300 px-2 py-1 rounded">CODE REQ: {clue.code}</p>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* --- FILES (NEW TAB) --- */}
        {activeTab === 'FILES' && (
          <div className="space-y-6 sm:space-y-8 animate-fade-in">
            <h2 className="text-2xl sm:text-3xl font-black text-stone-900 text-center uppercase decoration-wavy underline decoration-stone-500">Archives</h2>
            
            {CASE_FILES.map((file, idx) => {
              const rotate = idx % 2 === 0 ? 'rotate-[1deg]' : 'rotate-[-1deg]';
              
              return (
                <div key={file.id} className={`bg-white border-2 border-stone-900 shadow-sketch-lg p-4 relative ${rotate}`}>
                  
                  {/* Visual: Paperclip */}
                  <div className="absolute -top-4 right-8 text-stone-400 transform -rotate-45">
                    <Paperclip size={32} className="sm:w-10 sm:h-10" />
                  </div>

                  {file.type === 'REPORT' && (
                    <div className="relative overflow-hidden">
                      <DoodleCoffeeStain />
                      <div className="border-b-4 border-stone-900 pb-2 mb-4 flex flex-col sm:flex-row sm:justify-between sm:items-end gap-1">
                        <h3 className="text-xl sm:text-2xl font-black uppercase text-stone-800 leading-none">{file.title}</h3>
                        <span className="font-mono text-[10px] sm:text-xs bg-stone-200 px-2 py-1 w-fit">{file.date}</span>
                      </div>
                      <p className="font-serif text-base sm:text-lg leading-relaxed text-stone-800">{file.content}</p>
                      {file.stamped && (
                        <div className="mt-4 border-4 border-red-700 text-red-700 font-black text-lg sm:text-xl inline-block px-4 py-2 transform -rotate-12 opacity-80 mix-blend-multiply">
                          CONFIDENTIAL
                        </div>
                      )}
                    </div>
                  )}

                  {file.type === 'FIR' && (
                    <div className="bg-stone-100 p-3 sm:p-4 border border-stone-300 font-mono text-xs sm:text-sm">
                      <div className="text-center border-b border-stone-400 pb-2 mb-2">
                        <h3 className="font-bold text-lg sm:text-xl uppercase">Police Department</h3>
                        <p className="text-[10px] sm:text-xs">First Information Report</p>
                      </div>
                      <div className="grid grid-cols-2 gap-3 sm:gap-4">
                        <div>
                          <span className="block font-bold text-[10px] sm:text-xs text-stone-500 uppercase">Location</span>
                          <p>{file.content.location}</p>
                        </div>
                        <div>
                          <span className="block font-bold text-[10px] sm:text-xs text-stone-500 uppercase">Complainant</span>
                          <p>{file.content.complainant}</p>
                        </div>
                        <div className="col-span-2">
                          <span className="block font-bold text-[10px] sm:text-xs text-stone-500 uppercase">Details</span>
                          <p>{file.content.details}</p>
                        </div>
                        <div className="col-span-2 bg-yellow-100 p-2 border border-yellow-200">
                          <span className="block font-bold text-[10px] sm:text-xs text-yellow-800 uppercase">Officer Notes</span>
                          <p className="italic text-yellow-900">"{file.content.notes}"</p>
                        </div>
                      </div>
                    </div>
                  )}

                  {file.type === 'IMAGE' && (
                    <div className="flex flex-col items-center">
                      <div className="bg-stone-900 p-2 pb-8 shadow-sm transform rotate-1 w-full max-w-[200px] sm:max-w-[250px] relative">
                        <div className="bg-white aspect-square w-full flex items-center justify-center overflow-hidden border border-stone-200">
                          {file.sketchType === 'CCTV_CHEF' && <DoodleStickFigure />}
                          {file.sketchType === 'MARTINI' && <DoodleMartini />}
                        </div>
                        <p className="text-white font-handwritten text-center mt-2 text-xs sm:text-sm">{file.title}</p>
                        <div className="absolute top-2 right-2 w-2 h-2 bg-red-600 rounded-full animate-pulse"></div>
                      </div>
                      <p className="mt-4 text-center font-bold text-stone-600 italic bg-stone-100 px-4 py-2 transform -rotate-1 shadow-sm border border-stone-200 text-xs sm:text-base">
                        "{file.caption}"
                      </p>
                    </div>
                  )}

                </div>
              );
            })}
          </div>
        )}

        {/* --- DOSSIER --- */}
        {activeTab === 'DOSSIER' && (
          <div className="animate-fade-in">
            <h2 className="text-2xl sm:text-3xl font-black text-stone-900 text-center uppercase mb-6 decoration-wavy underline decoration-red-500">Suspects</h2>
            <div className="grid grid-cols-1 gap-3 sm:gap-4">
              {CHARACTERS.map((char, i) => (
                <button 
                  key={char.id} 
                  onClick={() => setSelectedGuest(char)}
                  className="w-full text-left bg-white p-3 sm:p-4 border-2 border-stone-900 shadow-[4px_4px_0px_#e5e5e5] flex items-center gap-3 sm:gap-4 hover:translate-x-1 transition-transform active:translate-y-1 active:shadow-none"
                >
                  <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 border-stone-900 flex items-center justify-center font-black text-lg sm:text-xl shadow-sm flex-shrink-0
                    ${char.id === currentUser ? 'bg-orange-500 text-white' : 'bg-stone-100 text-stone-400'}
                  `}>
                    {char.name.charAt(0)}
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex justify-between items-center gap-2">
                        <h4 className="font-black text-base sm:text-lg text-stone-900 truncate">{char.name}</h4>
                        {char.id === currentUser && <span className="text-[10px] bg-stone-900 text-white px-1 font-bold whitespace-nowrap">(YOU)</span>}
                    </div>
                    <p className="text-[10px] sm:text-xs font-bold text-red-600 uppercase tracking-wide truncate">{char.profession}</p>
                    <p className="text-xs sm:text-sm text-stone-500 italic mt-1 font-serif leading-tight truncate">"{char.quirk}"</p>
                  </div>
                </button>
              ))}
            </div>
          </div>
        )}

        {/* --- DECODER FAB --- */}
        <button
          onClick={() => setModalOpen(true)}
          className="fixed bottom-20 sm:bottom-24 right-4 sm:right-6 w-14 h-14 sm:w-16 sm:h-16 bg-red-600 border-4 border-stone-900 text-white rounded-full shadow-[4px_4px_0px_#1c1917] flex items-center justify-center hover:scale-110 transition-transform z-40 active:translate-y-1 active:shadow-none"
        >
          <Calculator size={28} className="sm:w-8 sm:h-8" />
        </button>

      </main>

      {/* --- NAV --- */}
      <nav className="fixed bottom-0 w-full bg-stone-900 border-t-4 border-red-700 pb-safe z-30 shadow-2xl">
        <div className="flex justify-around items-center h-16 sm:h-20 max-w-2xl mx-auto">
          <button 
            onClick={() => setActiveTab('DASHBOARD')}
            className={`flex flex-col items-center gap-1 w-full h-full justify-center transition-colors active:bg-stone-800 ${activeTab === 'DASHBOARD' ? 'text-orange-500' : 'text-stone-500'}`}
          >
            <User size={20} className="sm:w-6 sm:h-6" strokeWidth={3} />
            <span className="text-[10px] sm:text-xs font-black uppercase">ID Card</span>
          </button>
          
          <button 
            onClick={() => setActiveTab('INTEL')}
            className={`flex flex-col items-center gap-1 w-full h-full justify-center transition-colors active:bg-stone-800 ${activeTab === 'INTEL' ? 'text-orange-500' : 'text-stone-500'}`}
          >
            <div className="relative">
                <Search size={20} className="sm:w-6 sm:h-6" strokeWidth={3} />
                {unlockedClues.length < CLUE_DB.length && (
                    <span className="absolute -top-1 -right-1 w-2 h-2 bg-red-600 rounded-full border border-stone-900"></span>
                )}
            </div>
            <span className="text-[10px] sm:text-xs font-black uppercase">Clues</span>
          </button>

          <button 
            onClick={() => setActiveTab('FILES')}
            className={`flex flex-col items-center gap-1 w-full h-full justify-center transition-colors active:bg-stone-800 ${activeTab === 'FILES' ? 'text-orange-500' : 'text-stone-500'}`}
          >
            <FileText size={20} className="sm:w-6 sm:h-6" strokeWidth={3} />
            <span className="text-[10px] sm:text-xs font-black uppercase">Files</span>
          </button>

          <button 
            onClick={() => setActiveTab('DOSSIER')}
            className={`flex flex-col items-center gap-1 w-full h-full justify-center transition-colors active:bg-stone-800 ${activeTab === 'DOSSIER' ? 'text-orange-500' : 'text-stone-500'}`}
          >
            <Users size={20} className="sm:w-6 sm:h-6" strokeWidth={3} />
            <span className="text-[10px] sm:text-xs font-black uppercase">Guests</span>
          </button>
        </div>
      </nav>

      {/* --- GUEST PROFILE MODAL --- */}
      {selectedGuest && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-stone-900/90 backdrop-blur-sm animate-fade-in p-0 sm:p-4">
          <div className="bg-[#f4f1ea] w-full max-w-md p-6 border-t-4 sm:border-4 border-stone-900 shadow-[0px_-4px_10px_rgba(0,0,0,0.5)] sm:shadow-[8px_8px_0px_#ef4444] relative rotate-0 sm:rotate-1 overflow-y-auto max-h-[85vh] sm:rounded-none rounded-t-2xl">
            <div className="w-12 h-1 bg-stone-300 rounded-full mx-auto mb-4 sm:hidden"></div>
            <button 
                onClick={() => setSelectedGuest(null)}
                className="absolute top-4 right-4 bg-stone-900 text-white p-2 border-2 border-white hover:bg-red-600 transition-colors shadow-lg z-10 sm:-top-4 sm:-right-4"
            >
                <X size={20} className="sm:w-6 sm:h-6" />
            </button>
            
            <div className="flex flex-col items-center mb-6 mt-4 sm:mt-0">
                 <div className={`w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-stone-900 flex items-center justify-center font-black text-3xl sm:text-4xl shadow-sm mb-4
                    ${selectedGuest.id === currentUser ? 'bg-orange-500 text-white' : 'bg-stone-200 text-stone-500'}
                  `}>
                    {selectedGuest.name.charAt(0)}
                  </div>
                <h3 className="text-2xl sm:text-3xl font-black text-stone-900 uppercase text-center leading-none mb-2">{selectedGuest.name}</h3>
                <span className="bg-stone-900 text-white px-3 py-1 text-xs sm:text-sm font-bold shadow-sm transform -rotate-1">
                    {selectedGuest.profession}
                </span>
            </div>

            <div className="space-y-4 pb-8 sm:pb-0">
                 {/* Public Status */}
                 <div className="text-center">
                    {selectedGuest.role === 'VICTIM' ? (
                         <span className="inline-block border-2 border-purple-900 text-purple-900 bg-purple-100 px-3 py-1 font-black uppercase text-xs sm:text-sm rotate-2">
                             KNOWN VICTIM
                         </span>
                    ) : (
                        <span className="inline-block border-2 border-stone-400 text-stone-400 bg-stone-100 px-3 py-1 font-black uppercase text-xs sm:text-sm -rotate-1">
                             SUSPECT
                         </span>
                    )}
                 </div>

                {/* Bio Section */}
                <div className="bg-white p-4 border-2 border-stone-200 rounded-sm relative mt-6">
                    <div className="absolute -top-3 -left-2 bg-stone-800 text-white px-2 py-0.5 text-[10px] sm:text-xs rotate-[2deg] border border-stone-900 shadow-sm">BIO</div>
                    <p className="text-stone-700 leading-relaxed font-bold text-sm sm:text-base">{selectedGuest.bio}</p>
                </div>

                {/* Quirk Section */}
                <div className="bg-orange-50 p-4 border-2 border-orange-200 rounded-sm relative">
                    <div className="absolute -top-3 -right-2 bg-orange-500 text-white px-2 py-0.5 text-[10px] sm:text-xs rotate-[-3deg] border border-stone-900 shadow-sm">KNOWN TRAIT</div>
                    <p className="text-stone-800 italic font-serif text-sm sm:text-base">"{selectedGuest.quirk}"</p>
                </div>

                {/* Note: Secrets and Codes are intentionally hidden for other players */}
                {selectedGuest.id === currentUser && (
                     <div className="mt-6 border-t-2 border-dashed border-stone-300 pt-4 text-center">
                        <p className="text-xs text-red-600 font-bold uppercase mb-1">THIS IS YOU</p>
                        <p className="text-[10px] sm:text-xs text-stone-400">Check your ID Card tab for secret info.</p>
                     </div>
                )}
            </div>
          </div>
        </div>
      )}

      {/* --- DECODER MODAL --- */}
      {modalOpen && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-stone-900/90 backdrop-blur-sm animate-fade-in p-0 sm:p-4">
          <div className="bg-[#f4f1ea] w-full max-w-md p-6 border-t-4 sm:border-4 border-stone-900 shadow-[0px_-4px_10px_rgba(0,0,0,0.5)] sm:shadow-[8px_8px_0px_#ef4444] relative rotate-0 sm:rotate-1 rounded-t-2xl sm:rounded-none">
            <div className="w-12 h-1 bg-stone-300 rounded-full mx-auto mb-4 sm:hidden"></div>
            <button 
                onClick={() => setModalOpen(false)}
                className="absolute top-4 right-4 bg-stone-900 text-white p-2 border-2 border-white hover:bg-red-600 transition-colors shadow-lg sm:-top-4 sm:-right-4"
            >
                <X size={20} className="sm:w-6 sm:h-6" />
            </button>
            
            <div className="flex flex-col items-center mb-6 mt-2 sm:mt-0">
                <h3 className="text-2xl sm:text-3xl font-black text-stone-900 uppercase underline decoration-4 decoration-red-600">Enter Code</h3>
                <p className="text-stone-600 font-bold mt-2 text-center text-sm sm:text-base">Found a clue? Type it below.</p>
            </div>

            <form onSubmit={handleCodeSubmit} className="space-y-4 pb-6 sm:pb-0">
                <div className="relative">
                    <input 
                        type="text" 
                        value={inputCode}
                        onChange={(e) => setInputCode(e.target.value)}
                        placeholder="SECRET CODE..."
                        className="w-full bg-white border-4 border-stone-900 text-red-700 text-center text-2xl sm:text-3xl font-black py-3 sm:py-4 focus:outline-none focus:border-orange-500 uppercase tracking-widest placeholder:text-stone-300 shadow-inner"
                        autoFocus
                    />
                </div>
                <button 
                    type="submit"
                    className="w-full bg-stone-900 hover:bg-stone-800 text-white text-lg sm:text-xl font-black py-3 sm:py-4 border-b-4 border-red-700 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 uppercase"
                >
                    UNLOCK <ChevronRight size={24} />
                </button>
            </form>
            
            <div className="mt-6 text-center">
                <p className="text-[10px] sm:text-sm font-bold text-stone-400 uppercase">Warning: Three failed attempts alerts the killer.</p>
            </div>
          </div>
        </div>
      )}
      
      <style>{`
        body { font-family: 'Gloria Hallelujah', 'Comic Sans MS', 'Chalkboard SE', 'Comic Neue', sans-serif; }
        .font-handwritten { font-family: 'Gloria Hallelujah', 'Comic Sans MS', 'Chalkboard SE', 'Comic Neue', sans-serif; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e7e5e4; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ea580c; border: 2px solid #e7e5e4; border-radius: 0; }
        
        .shadow-sketch { box-shadow: 2px 2px 0px 0px #1c1917; }
        .shadow-sketch-lg { box-shadow: 4px 4px 0px 0px #1c1917; }
        
        .bg-texture {
            background-image: radial-gradient(#d6d3d1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes bounceShort { 0%, 100% { transform: translateY(0) rotate(1deg); } 50% { transform: translateY(-5px) rotate(1deg); } }
        .animate-bounce-short { animation: bounceShort 0.5s ease-in-out 1; }
      `}</style>
    </div>
  );
}